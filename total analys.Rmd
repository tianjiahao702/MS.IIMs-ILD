---
title: "total analys"
author: "Jiahao Tian"
date: "2023-05-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(readr)
library(tumgr)
library(minpack.lm)
library(survival)
library(survminer)
library(grid)
library(lme4)
library(rstanarm)
library(bayesplot)
library(loo)
```


```{r}
t_df = read.csv("treat_combine.csv", sep = ",", header = TRUE)

```

```{r}
t_df$log_g = log(t_df$g)
t_df$log_d = log(t_df$d)

hist(t_df$log_g, main = "Tumor Growth Rate Distribution", xlab = "Tumor Growth Rate", col = "lightblue", border = "black")

hist(t_df$log_d, main = "Tumor Growth Rate Distribution", xlab = "Tumor Growth Rate", col = "lightblue", border = "black")
```


```{r}
g_df = t_df[!is.na(t_df$g) & !is.na(t_df$Death),]
g_df = g_df %>%
  filter(!(selectedFit %in% c("gd", "gdphi")))


# Calculate the tertiles of the log growth rate
log_growth_tertiles = quantile(g_df$g, probs = c(1/2))

# Create a new column with the tertile groups
g_df$log_growth_tertile = cut(g_df$g,
                                  breaks = c(-Inf, log_growth_tertiles, Inf),
                                  labels = c(1, 2),
                                  include.lowest = TRUE)


d_df = t_df[!is.na(t_df$d) & !is.na(t_df$Death), ]
d_df = d_df %>%
  filter(!(selectedFit %in% c("gd", "gdphi")))


# Calculate the tertiles of the log growth rate
log_decay_tertiles = quantile(d_df$d, probs = c(1/2))

# Create a new column with the tertile groups
d_df$log_decay_tertile = cut(d_df$d,
                                  breaks = c(-Inf, log_decay_tertiles, Inf),
                                  labels = c(1, 2),
                                  include.lowest = TRUE)

t_df11 = merge(t_df, select(g_df, name, log_growth_tertile), by = "name", all.x = TRUE)

t_df11 = merge(t_df11, select(d_df, name, log_decay_tertile), by = "name", all.x = TRUE)
```


```{R}
# Create a new column
t_df11$group = ifelse(t_df11$selectedFit %in% c("gd", "gdphi"), 5, NA)

t_df11 = t_df11 %>%
  mutate(group = case_when(
    log_growth_tertile == 1 ~ "low growth",
    log_growth_tertile == 2 ~ "high growth",
    log_decay_tertile == 1 ~ "low decay",
    log_decay_tertile == 2 ~ "high decay",
    TRUE ~ as.character(group)
  ))
```

```{r}
# Change value 5 to "yoyo" in the "sur_5" column
t_df11$group = ifelse(t_df11$group == 5, "yoyo", t_df11$group)

```

```{r}
stable = t_df11 %>%
  filter(!(selectedFit %in% c("gd", "gdphi", "gx", "dx","not fit")))

colnames(stable)[which(names(stable) == "selectedFit")] = "no_20_diff"


t_df11 = merge(t_df11, select(stable, name, no_20_diff), by = "name", all.x = TRUE)

library(stringr)

t_df11 = t_df11 %>%
  mutate(group = case_when(
    str_trim(no_20_diff) == "2 evals not 20% diff" ~ "stable",
    TRUE ~ as.character(group)
  ))


```

```{r}
t_df11$group = ifelse(is.na(t_df11$group), "Not Fit", t_df11$group)

```


t_df11 = t_df11 %>%
  mutate(g = case_when(
    log_growth_tertile == 1 ~ "low growth",
    log_growth_tertile == 2 ~ "high growth",
    log_decay_tertile == 1 ~ "low decay",
    log_decay_tertile == 2 ~ "high decay",
    TRUE ~ as.character(group)
  ))




```{r}
tdf111 = t_df11[!is.na(t_df11$Death), ]

#sur_df = t_df11[!(t_df11$group == "remainder"), ]

```


```{r}
new_t = read.csv(
  "~/Desktop/MSRpt/data/new treatment comb/IIMQILD_221104_TxGadd.csv", header = TRUE, sep = ",")

new_t = new_t %>% 
  dplyr:: select(Patient_ID,
                 AE_ILD,
                 AE_Date,
                 AE_Du,
                 LastFUdate_TPLfree,
                 Death,
                 DeathDate,
                 V1_CTdate,
                 V2_CTdate,
                 V3_CTdate,
                 GCIS,
                 GCIS_3G,
                 ISintG4,
                 ISintG3,
                 DIAG)

colnames(new_t)[which(names(new_t) == "Patient_ID")] = "SUBJID"
```


```{R}
new_t$last_CTdate = ifelse(is.na(new_t$V3_CTdate) | new_t$V3_CTdate == "", new_t$V2_CTdate, new_t$V3_CTdate)
```

```{r}
new_t$DEATHorAE = ifelse(is.na(new_t$Death) | new_t$Death == 0, new_t$AE_ILD, new_t$Death)


```

```{r}
new_t$lastfud = ifelse(is.na(new_t$DeathDate) | new_t$DeathDate == "", new_t$LastFUdate_TPLfree, new_t$DeathDate)
new_t$lastfud = as.Date(new_t$lastfud, format = "%d-%b-%y")
new_t$lastfud = as.numeric(new_t$lastfud)
```

```{r}

new_t$lastfud_AE = ifelse(new_t$AE_Date != "", new_t$AE_Date,
                 ifelse(new_t$DeathDate != "", new_t$DeathDate, new_t$LastFUdate_TPLfree))
new_t$lastfud_AE = as.Date(new_t$lastfud_AE, format = "%d-%b-%y")
new_t$lastfud_AE = as.numeric(new_t$lastfud_AE)


new_t$lastctd = as.Date(new_t$last_CTdate, format = "%d-%b-%y")
new_t$lastctd = as.numeric(new_t$lastctd)
```


```{r}
new_t$chang_in_date = new_t$lastfud - new_t$lastctd
new_t$chang_in_date = new_t$chang_in_date / 30

new_t$chang_in_date_AE = new_t$lastfud_AE - new_t$lastctd
new_t$chang_in_date_AE = new_t$chang_in_date_AE / 30
```


```{R}
new_t$ISintG3 = ifelse(new_t$ISintG3 == "0", "ISint3_G1", new_t$ISintG3)

new_t$ISintG3 = ifelse(new_t$ISintG3 == "1", "ISint3_G2", new_t$ISintG3)

new_t$ISintG3 = ifelse(new_t$ISintG3 == "2", "ISint3_G3", new_t$ISintG3)
```


```{r}
new_t$ISintG4 = ifelse(new_t$ISintG4 == "ISint4_G1", "ISint4_G0", new_t$ISintG4)

new_t$ISintG4 = ifelse(new_t$ISintG4 == "ISint4_G2", "ISint4_G1", new_t$ISintG4)

new_t$ISintG4 = ifelse(new_t$ISintG4 == "ISint4_G3", "ISint4_G2", new_t$ISintG4)

new_t$ISintG4 = ifelse(new_t$ISintG4 == "ISint4_G4", "ISint4_G3", new_t$ISintG4)

```

```{r}
new_t$treat_G2 = ifelse(new_t$ISintG4 == "ISint4_G0", "G1", new_t$ISintG4)
new_t$treat_G2 = ifelse(new_t$treat_G2 == "ISint4_G1", "G1", new_t$treat_G2)

new_t$treat_G2 = ifelse(new_t$treat_G2 == "ISint4_G2", "G2", new_t$treat_G2)
new_t$treat_G2 = ifelse(new_t$treat_G2 == "ISint4_G3", "G2", new_t$treat_G2)
```

```{R}
new_t$firstcts = as.Date(new_t$V1_CTdate, format = "%d-%b-%y")
new_t$firstcts = as.numeric(new_t$firstcts)
new_t$total_fu_date = new_t$lastfud - new_t$firstcts


qlfffffff = merge(qlfffffff, select(new_t, SUBJID, total_fu_date), by = "SUBJID")

qlfffffff$total_fu_date = qlfffffff$total_fu_date / 30


```

```{R}
qlfffffff = merge(qlfffffff, select(new_t, SUBJID, chang_in_date_AE), by = "SUBJID")


```

```{r}
qlfffffff = merge(tdf111, new_t, by = "SUBJID")
#qildddddd = merge(data1_qild, new_t, by = "SUBJID")


```

```{R}
qlfffffff$qlf_change = ifelse(qlfffffff$change < 0, "-", ifelse(qlfffffff$change > 0, "+", "0"))


```


```{R}
qlfffffff$group = ifelse(qlfffffff$group == "yoyo", "convex", qlfffffff$group)
qlfffffff$group = ifelse(qlfffffff$group == "Not Fit", "concave", qlfffffff$group)
```

```{r}
qildddddd = merge(qildddddd, select(new_t, SUBJID, chang_in_date_AE), by = "SUBJID")

qildddddd$group = ifelse(qildddddd$group == "yoyo", "convex", qildddddd$group)
```

```{r}
qildddddd$group = ifelse(qildddddd$group == "remainder", "concave", qildddddd$group)

```

```{r}
qlfffffff = merge(qlfffffff, select(new_t, SUBJID, treat_G2), by = "SUBJID")

```

```{R}
qlfffffff = qlfffffff %>%
  mutate(group = case_when(
    selectedFit == "gx" ~ "growth",
    selectedFit == "dx" ~ "decay",
    selectedFit == "gd" ~ "convex",
    selectedFit == "gdphi" ~ "convex",
    selectedFit == "not fit" ~ "concave",
    selectedFit == "2 evals not 20% diff" ~ "stable",
    TRUE ~ selectedFit
  ))
```

```{r}
buzhongyao = qlfffffff

buzhongyao = buzhongyao %>%
  mutate(Patterns = case_when(
    new_group == "lgldys+high decay" ~ "the rest",
    TRUE ~ new_group
  ))


```

##### Part 1.


- Kaplan-Meier curve for visualizing survival, death as event. Three curves, which are separated as three part by tertiles for both g and d.

```{r}
sur_qlf = qlfffffff[qlfffffff$V3_CTdate.x != "", ]
sur_qild = qildddddd[qildddddd$V3_CTdate.x != "", ]


```

```{r}
library(ggfortify)

#mypalette = c("high growth" = "firebrick3", "low growth" = "indianred1",
              #"high decay" = "forestgreen", "low decay" = "springgreen3",
              #"stable" = "goldenrod1", 
              #"convex" = "slateblue", "concave" = "grey46")
#qlfffffff$group = as.factor(qlfffffff$group)

#levels(qlfffffff$group) = c("high growth", "low growth", "high decay", "low decay", "stable", "convex", "concave")

surv_obj = Surv(buzhongyao$chang_in_date, buzhongyao$Death.y)

# Fit the Kaplan-Meier model for the subset
km_fit = survfit(surv_obj ~ buzhongyao$Patterns)

# Plot the Kaplan-Meier curve for the subset
sur_km = ggsurvplot(km_fit, data = buzhongyao, 
                    risk.table = TRUE, 
                    pval = TRUE,
                    xlab = "Time (in month)",
                    palette = c("grey46", "firebrick3", "burlywood3"))# "goldenrod1") ) 

sur_km
```



```{r}
### no need

library(ggfortify)
g_surv_obj = Surv(g_df$time_mon, g_df$Death)

# Fit the Kaplan-Meier model for the subset
g_km_fit = survfit(g_surv_obj ~ g_df$log_growth_tertile)

# Plot the Kaplan-Meier curve for the subset
g_km = ggsurvplot(g_km_fit, data = g_df, risk.table = TRUE, pval = TRUE)
g_km

plot(g_km_fit, log = "x", xlab = "Time (log scale)", ylab = "Survival probability")



d_surv_obj = Surv(d_df$time_mon, d_df$Death)

# Fit the Kaplan-Meier model for the subset
d_km_fit = survfit(d_surv_obj ~ d_df$log_decay_tertile)

# Plot the Kaplan-Meier curve for the subset
d_km = ggsurvplot(d_km_fit, data = d_df, risk.table = TRUE, pval = TRUE)
d_km
autoplot(d_km_fit)

plot(d_km_fit, log = "x", xlab = "Time (log scale)", ylab = "Survival probability")

```


- Hazard ratios for each tertile of the growth rate and decay rate, as well as for other factors of interest(remainder: no 20% differ, and not fit).

- As whole

```{r}
## extract remainders.
t_df$remainder = ifelse(is.na(t_df$log_g) & is.na(t_df$log_d), 1, 0)
t_df = t_df[!is.na(t_df$Death), ]
```



```{R}
# Create binary variables for each tertile group
g_df$growth_tertile1 = ifelse(g_df$log_growth_tertile == 1, 1, 0)
g_df$growth_tertile2 = ifelse(g_df$log_growth_tertile == 2, 1, 0)
g_df$growth_tertile3 = ifelse(g_df$log_growth_tertile == 3, 1, 0)

d_df$decay_tertile1 = ifelse(d_df$log_decay_tertile == 1, 1, 0)
d_df$decay_tertile2 = ifelse(d_df$log_decay_tertile == 2, 1, 0)
d_df$decay_tertile3 = ifelse(d_df$log_decay_tertile == 3, 1, 0)
```

```{R}
g_selected = g_df[, c("name", "growth_tertile1", "growth_tertile2", "growth_tertile3")]

d_selected = d_df[, c("name", "decay_tertile1","decay_tertile2", "decay_tertile3")]

t_df = merge(t_df, g_selected, by = "name", all.x = TRUE)
t_df = merge(t_df, d_selected, by = "name", all.x = TRUE)
```

```{r}
# Replace NAs in tertile group with 0
t_df$growth_tertile1 = replace(t_df$growth_tertile1, is.na(t_df$growth_tertile1), 0)
t_df$growth_tertile2 = replace(t_df$growth_tertile2, is.na(t_df$growth_tertile2), 0)
t_df$growth_tertile3 = replace(t_df$growth_tertile3, is.na(t_df$growth_tertile3), 0)

t_df$decay_tertile1 = replace(t_df$decay_tertile1, is.na(t_df$decay_tertile1), 0)
t_df$decay_tertile2 = replace(t_df$decay_tertile2, is.na(t_df$decay_tertile2), 0)
t_df$decay_tertile3 = replace(t_df$decay_tertile3, is.na(t_df$decay_tertile3), 0)
```

```{r}


# Add a new column for growth and decay groups
t_df = t_df %>%
  mutate(
    only_growth = case_when(
      growth_tertile1 == 1 ~ "growth_tertile1",
      growth_tertile2 == 1 ~ "growth_tertile2",
      growth_tertile3 == 1 ~ "growth_tertile3",
      TRUE ~ "none"
    ),
    only_decay = case_when(
      decay_tertile1 == 1 ~ "decay_tertile1",
      decay_tertile2 == 1 ~ "decay_tertile2",
      decay_tertile3 == 1 ~ "decay_tertile3",
      TRUE ~ "none"
    )
  ) 

# Now create the combined_g variable
t_df = mutate(t_df, combined_g = case_when(
  `decay_tertile2` == 1 & `growth_tertile3` == 1 ~ "middle decay and high growth",
  `decay_tertile3` == 1 & `growth_tertile2` == 1 ~ "high decay and middle growth",
  `decay_tertile3` == 1 & `growth_tertile1` == 1 ~ "high decay and slow growth",
  `decay_tertile2` == 1 & `growth_tertile2` == 1 ~ "middle decay and middle growth",
  `decay_tertile1` == 1 & `growth_tertile2` == 1 ~ "slow decay and middle growth",
  `decay_tertile2` == 1 & `growth_tertile1` == 1 ~ "middle decay and slow growth",
  `only_decay` ==  "decay_tertile1" ~ "decay_tertile1",
  `only_decay` ==  "decay_tertile2" ~ "decay_tertile2",
  `only_decay` ==  "decay_tertile3" ~ "decay_tertile3",
  `only_growth` == "growth_tertile1" ~ "growth_tertile1", 
  `only_growth` == "growth_tertile2" ~ "growth_tertile2",
  `only_growth` == "growth_tertile3" ~ "growth_tertile3",
  `remainder` == 1 ~ "Remainder"))



```

```{R}
## bad
# Fit the Cox proportional hazards model
model = coxph(Surv(chang_in_date, Death.x) ~ grouplow.decay + grouphigh.decay +
                        grouphigh.growth + grouplow.growth + groupNot.Fit +
                        groupyoyo, data = qlfffffff, iter.max = 1000)
summary(model)

```


```{r}

##bad

library(finalfit)
dependent = "Surv(time_mon, Death)"
explanatory = c("combined_g")

t_df %>%
  finalfit(dependent, explanatory)

t_df %>% 
    finalfit(dependent, explanatory, add_dependent_label = FALSE) %>% 
    rename("Death" = label) %>% 
    rename(" " = levels) %>% 
    rename("  " = all)


```


```{r}
## only g-3 d-1 remainder shows association
library(finalfit)
dependent = "Surv(time_mon, Death)"
explanatory = c("Age", "Sex", 
                "growth_tertile1", "growth_tertile2",
                "growth_tertile3", "decay_tertile1",
                "decay_tertile2", "decay_tertile3",
                "remainder")
t_df %>%
  finalfit(dependent, explanatory)

t_df %>% 
    finalfit(dependent, explanatory, add_dependent_label = FALSE) %>% 
    rename("Death" = label) %>% 
    rename(" " = levels) %>% 
    rename("  " = all)

```


```{R}
t_df %>% 
    coxphmulti(dependent, explanatory) %>% 
    cox.zph() %>% 
    {zph_result <<- .} %>% 
    plot(var=5)

zph_result
```



```{r}
### bad
model = coxph(Surv(time_mon, Death) ~ growth_tertile1 + 
                 growth_tertile2 + growth_tertile3 + 
                 decay_tertile1 + decay_tertile2 +
                 decay_tertile3 + remainder, data = t_df, iter.max= 1000)

# Extract hazard ratios
tibble::tibble(exp(model$coef))
summary(model)

```


- By growth group

```{r}
t_df$g_group = NA
t_df$g_group[t_df$growth_tertile1 == 1] = "growth_tertile1"
t_df$g_group[t_df$growth_tertile2 == 1] = "growth_tertile2"
t_df$g_group[t_df$growth_tertile3 == 1] = "growth_tertile3"
t_df$g_group[t_df$remainder == 1] = "g_remainder"

g_t_df = t_df[!is.na(t_df$g_group), ]

g_t_df$g_group = as.factor(g_t_df$g_group)
```

```{r}

## g-3 only
library(finalfit)
dependent = "Surv(time_mon, Death)"
explanatory = c("Sex", "Age","g_group")

g_t_df %>%
  finalfit(dependent, explanatory)

g_t_df %>% 
    finalfit(dependent, explanatory, add_dependent_label = FALSE) %>% 
    rename("Death" = label) %>% 
    rename(" " = levels) %>% 
    rename("  " = all)


```



```{r}
model = coxph(Surv(time_mon, Death) ~ g_group, data = g_t_df, iter.max = 1000)

exp(model$coef)

```

- By decay group

```{r}
t_df$d_group = NA
t_df$d_group[t_df$decay_tertile1 == 1] = "decay_tertile1"
t_df$d_group[t_df$decay_tertile2 == 1] = "decay_tertile2"
t_df$d_group[t_df$decay_tertile3 == 1] = "decay_tertile3"
t_df$d_group[t_df$remainder == 1] = "d_remainder"

d_t_df = t_df[!is.na(t_df$d_group), ]

d_t_df$d_group = as.factor(d_t_df$d_group)
```

```{r}
model = coxph(Surv(time_mon, Death) ~ d_group, data = d_t_df, iter.max = 1000)

exp(model$coef)

```

- By remainder group

```{r}
model = coxph(Surv(time_mon, Death) ~ remainder, data = t_df, iter.max = 1000)

exp(model$coef)
```


```{r}

## bad
# Add a new column for growth and decay groups
tt_df = t_df %>%
  mutate(
    growth_group = case_when(
      growth_tertile1 == 1 ~ "growth_tertile1",
      growth_tertile2 == 1 ~ "growth_tertile2",
      growth_tertile3 == 1 ~ "growth_tertile3",
      TRUE ~ "none"
    ),
    decay_group = case_when(
      decay_tertile1 == 1 ~ "decay_tertile1",
      decay_tertile2 == 1 ~ "decay_tertile2",
      decay_tertile3 == 1 ~ "decay_tertile3",
      TRUE ~ "none"
    )
  ) 

# Identify patients who belong to both growth and decay groups
tt_df = tt_df %>%
  mutate(
    both_growth_decay = ifelse(growth_group != "none" & decay_group != "none", 1, 0)
  )

# Create a new combined group variable
tt_df = tt_df %>%
  mutate(
    combined_group = case_when(
      both_growth_decay == 1 ~ "both_growth_decay",
      growth_group != "none" ~ as.character(growth_group),
      decay_group != "none" ~ as.character(decay_group),
      remainder == 1 ~ "remainder",
      TRUE ~ "none"
    )
  )
# Fit the Cox proportional hazards model with the combined group variable
model = coxph(Surv(time_mon, Death) ~ combined_group, data = tt_df)

# Print the summary of the model
summary(model)

```

######################### penalized regression methods

```{R}
## penalized regression methods
## fit a LASSO-penalized Cox proportional hazards model
## shrink the coefficients towards zero, help improve the stability of the estimates in our cases with small sample sizes.

library(glmnet)
X = t_df[, c("growth_tertile1", "growth_tertile2", "growth_tertile3",
              "decay_tertile1", "decay_tertile2", "decay_tertile3", "remainder")]

X = as.matrix(X)  # Convert the data frame to a matrix

Y = Surv(t_df$time_mon, t_df$Death)

set.seed(123)  # For reproducibility
cv_fit = cv.glmnet(x = X, y = Y, family = "cox", alpha = 1)

plot(cv_fit)

optimal_lambda = cv_fit$lambda.min
coef(cv_fit, s = optimal_lambda)

```

```{R}
coefficients = c(-1.3961258, -0.8303949, 2.7472011, 0, -0.7827922, 0, 0.3815424)
hazard_ratios = exp(coefficients)
hazard_ratios



```


```{r}
t_df11$remainder = ifelse(is.na(t_df11$log_g) & is.na(t_df11$log_d), 1, 0)
```

```{r}
t_df22 = t_df11[!is.na(t_df11$Death), ]

t_df22$group = replace(t_df22$group, is.na(t_df22$group), "remainder")


t_df22 = t_df22 %>%
  mutate(across(group, ~ as.integer(. == "low decay"), .names = "low_decay"),
         across(group, ~ as.integer(. == "high decay"), .names = "high_decay"),
         across(group, ~ as.integer(. == "low growth"), .names = "low_growth"),
         across(group, ~ as.integer(. == "high growth"), .names = "high_growth"),
         across(group, ~ as.integer(. == "yoyo"), .names = "yoyo"),
         across(group, ~ as.integer(. == "remainder"), .names = "remainder"),
         across(group, ~ as.integer(. == "stable"), .names = "stable"))


```

```{r}

# Create a new binary column based on the existing column
t_df22$decay = ifelse(t_df22$group %in% c("low decay", "high decay"), 1, 0)
t_df22$growth = ifelse(t_df22$group %in% c("low growth", "high growth"), 1, 0)


```


```{R}
hr_58 = t_df22[!(t_df22$selectedFit %in% c("not fit")), ]
```

```{r}
#tdf33 = t_df22
hr_58$group = as.factor(hr_58$group)

hr_58$group = relevel(hr_58$group, ref = "high growth")
```


```{r}
#model = coxph(Surv(time_mon, Death) ~ group, data = hr_58, iter.max = 50)


model = coxph(Surv(time_mon, Death) ~ low_decay + stable + low_growth + 
                 high_growth + yoyo, data = hr_58, control = coxph.control(iter.max = 50))


#t_df22$group_var = relevel(as.factor(t_df22$group), ref = "stable")

#model = coxph(Surv(time_mon, Death) ~ group_var, data = t_df22)


#model = coxph(Surv(time_mon, Death) ~ group, data = t_df22)
summary(model)

##Complete separation: Complete separation occurs when a predictor perfectly separates the two outcomes, meaning there's a predictor that perfectly predicts the event. When this happens, the maximum likelihood estimate does not exist, and NA values are returned.

```


```{R}
## penalized regression methods
## fit a LASSO-penalized Cox proportional hazards model
## shrink the coefficients towards zero, help improve the stability of the estimates in our cases with small sample sizes.

library(glmnet)
X = hr_58[, c("low_decay", "low_growth",
              "high_decay", "yoyo", "stable")]

X = as.matrix(X)  # Convert the data frame to a matrix

Y = Surv(hr_58$time_mon, hr_58$Death)

set.seed(123)  # For reproducibility
cv_fit = cv.glmnet(x = X, y = Y, family = "cox", alpha = 1)

plot(cv_fit)

optimal_lambda = cv_fit$lambda.min
coef(cv_fit, s = optimal_lambda)
exp(coef(cv_fit, s = optimal_lambda))

```

```{r}
# Number of bootstrap samples
B = 5000

# Initialize a matrix to store the bootstrap results
bootstrap_results = matrix(NA, nrow = B, ncol = ncol(X))
colnames(bootstrap_results) = colnames(X)

# Perform the bootstrap
set.seed(123)  # For reproducibility
for (b in 1:B) {
  # Sample with replacement from the rows of X and Y
  bootstrap_rows = sample(1:nrow(X), replace = TRUE)
  X_boot = X[bootstrap_rows, ]
  Y_boot = Y[bootstrap_rows]
  
  # Fit the model to the bootstrap sample
  cv_fit_boot = try(cv.glmnet(x = X_boot, y = Y_boot, family = "cox", alpha = 1), silent = TRUE)
  
  # If an error occurred during fitting, skip this bootstrap sample
  if (class(cv_fit_boot) == "try-error") {
    next
  }
  
  optimal_lambda_boot = cv_fit_boot$lambda.min
  
  # Get coefficients and convert them into a regular numeric vector
  coefs = as.numeric(coef(cv_fit_boot, s = optimal_lambda_boot))
  names(coefs) = rownames(coef(cv_fit_boot, s = optimal_lambda_boot))
  
  # If a variable is excluded from the model in a particular bootstrap sample,
  # its coefficient will not be present in the coefs vector.
  # We create a named numeric vector with names matching the column names of bootstrap_results.
  # If a coefficient is not present in coefs, it will be assigned NA in the results vector.
  results = rep(NA, ncol(X))
  names(results) = colnames(X)
  results[names(coefs)[-1]] = coefs[names(coefs)[-1]]  # Exclude the intercept
  
  # Store the coefficients
  bootstrap_results[b, ] = results
}

# Calculate the 2.5% and 97.5% quantiles of the bootstrap results
CI_lower = apply(bootstrap_results, 2, function(x) quantile(x, probs = 0.025, na.rm = TRUE))
CI_upper = apply(bootstrap_results, 2, function(x) quantile(x, probs = 0.975, na.rm = TRUE))

data.frame(CI_lower, CI_upper)

```


```{r}
# Number of bootstrap samples, non-parametric
B = 2000

# Initialize a matrix to store the bootstrap results
bootstrap_results = matrix(NA, nrow = B, ncol = ncol(X))
colnames(bootstrap_results) = colnames(X)

# Perform the bootstrap
set.seed(123)  # For reproducibility
for (b in 1:B) {
  # Sample with replacement from the rows of X and Y
  bootstrap_rows = sample(1:nrow(X), replace = TRUE)
  X_boot = X[bootstrap_rows, ]
  Y_boot = Y[bootstrap_rows]
  
  # Fit the model to the bootstrap sample
  cv_fit_boot = try(cv.glmnet(x = X_boot, y = Y_boot, family = "cox", alpha = 1), silent = TRUE)
  
  # If an error occurred during fitting, skip this bootstrap sample
  if (class(cv_fit_boot) == "try-error") {
    next
  }
  
  optimal_lambda_boot = cv_fit_boot$lambda.min
  
  # Get coefficients and convert them into a regular numeric vector
  coefs = as.numeric(coef(cv_fit_boot, s = optimal_lambda_boot))
  names(coefs) = rownames(coef(cv_fit_boot, s = optimal_lambda_boot))
  
  # If a variable is excluded from the model in a particular bootstrap sample,
  # its coefficient will not be present in the coefs vector.
  # We create a named numeric vector with names matching the column names of bootstrap_results.
  # If a coefficient is not present in coefs, it will be assigned NA in the results vector.
  results = setNames(rep(NA, ncol(X)), colnames(X))
  results[names(coefs)[-1]] = coefs[names(coefs)[-1]]  # Exclude the intercept
  
  # Store the coefficients
  bootstrap_results[b, ] = results
}

# Calculate the 2.5% and 97.5% quantiles of the bootstrap results
CI_lower = apply(bootstrap_results, 2, function(x) quantile(x, probs = 0.025, na.rm = TRUE))
CI_upper = apply(bootstrap_results, 2, function(x) quantile(x, probs = 0.975, na.rm = TRUE))

# Print the confidence intervals
data.frame(Coefficient = colnames(bootstrap_results), CI_lower, CI_upper)



```


```{r}
# Fit the model to the observed data
fit = survreg(Surv(time_mon, Death) ~ low_decay + 
                 high_decay + low_growth + 
                 high_growth + yoyo, data = t_df22)#, dist = "exponential")

# Number of bootstrap samples
B = 2000 

# Initialize a matrix to store the bootstrap results
bootstrap_results = matrix(NA, nrow = B, ncol = length(coef(cv_fit, s = optimal_lambda)))
colnames(bootstrap_results) = names(coef(cv_fit, s = optimal_lambda))

# Parametric bootstrap
set.seed(123)  # For reproducibility
for (b in 1:B) {
# Generate bootstrap response
Y_boot = rweibull(nrow(t_df22), shape = coef(fit)[1], 
                  scale = exp(coef(fit)[2] * t_df22$low_decay + coef(fit)[3] * t_df22$high_decay + coef(fit)[4] * t_df22$low_growth + coef(fit)[5] * t_df22$high_growth + coef(fit)[6] * t_df22$yoyo))

# Create a survival object with the bootstrap times and original censoring statuses
Y_boot = Surv(Y_boot, t_df22$Death)

# Fit the model to the bootstrap sample
# Fit the model to the bootstrap sample
cv_fit_boot = cv.glmnet(x = X, y = Y_boot, family = "cox", alpha = 0)

# Check if cv_fit_boot is a valid model object
if (inherits(cv_fit_boot, "try-error")) {
  print(paste("Error on bootstrap iteration", b))
  next
}
  
# Store the coefficients
bootstrap_results[b, ] = as.numeric(coef(cv_fit_boot, s = optimal_lambda))
}

# Calculate the 2.5% and 97.5% quantiles of the bootstrap results
CI_lower = apply(bootstrap_results, 2, function(x) quantile(x, probs = 0.025, na.rm = TRUE))
CI_upper = apply(bootstrap_results, 2, function(x) quantile(x, probs = 0.975, na.rm = TRUE))

# Print the confidence intervals
data.frame(Coefficient = colnames(bootstrap_results), CI_lower, CI_upper)



```




```{r}
# Exponentiate the coefficients and their confidence intervals to get hazard ratios and their CIs
HR = exp(coef(cv_fit, s = optimal_lambda))
CI_lower_HR = exp(CI_lower)
CI_upper_HR = exp(CI_upper)

# Print the hazard ratios and their confidence intervals
HR
CI_lower_HR
CI_upper_HR


```

##### Part 2.

- longituinal plot

```{r}
#treat = read.csv("treat_combine.csv", sep = ",", header = TRUE)

long_data = merge(qlf1, new_t, by = 'SUBJID', all = TRUE)

long_data$date = as.Date(long_data$VISITDTN, format = "%d%b%Y")

long_data$n_date = as.numeric(long_data$date)

#long_data$log_date = log(long_data$n_date)
#long_data$log_qlf = log(long_data$size)

#long_data = long_data[!is.na(long_data$Age), ]

```

################## by gd rate

```{r}
#long_data1 = long_data[!(long_data$selectedFit %in% c("not fit")), ]
long_data = long_data[!is.na(long_data$Death.x), ]

long_data$selectedFit = ifelse(long_data$selectedFit == "2 evals not 20% diff", "stable", long_data$selectedFit)
```

```{R}
lme_model = lmer(log_qlf ~ log_date + selectedFit  + (1 | name), data = long_data1)

# First, add the model predictions to the new_data dataframe
#long_data$predicted_tumor_size = predict(lme_model, long_data)
long_data1$predicted_tumor_size = predict(lme_model, re.form = NULL)

library(ggplot2)

custom_palette = c("gx" = "firebrick3", "dx" = "forestgreen", "stable" = "goldenrod1", "gd" = "steelblue1", "gdphi" = "purple1", "not fit" = "grey46")


# Find the last observation for each subject
last_obs = long_data %>%
  group_by(name) %>%
  filter(date == max(date))

ggplot(long_data, aes(x = date, y = QLFCAD, group = name, color = selectedFit)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = custom_palette) +
  theme_minimal() +
  labs(#title = "QLF Score (log scale)",
       x = "Visit Date",
       y = "QLF Score (per visit)",
       color = "selectedFit") +
  geom_text(data = last_obs, aes(label = name), hjust = -0.1, vjust = 0.5, size = 3, check_overlap = TRUE)+
  theme_grey(base_size = 25) +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  theme(axis.text = element_text(size = 15),  # Increase size of side labels
        legend.position = "right")

```


```{r}
library(nlme)
library(ggplot2)

lme_model = lme(log_qlf ~ log_date + Age + Sex + selectedFit, random = ~1 | name, data = long_data1)

long_data1$predicted_tumor_size = predict(lme_model, level = 0)

custom_palette = c("#00AFBB", "#E7B800", "#FC4E07", "black", "red") 

ggplot(long_data1, aes(x = date, y = predicted_tumor_size, group = name, color = selectedFit)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = custom_palette) +
  theme_minimal() +
  labs(title = "Predicted Tumor Sizes",
       x = "Visit Date",
       y = "Tumor Size",
       color = "selectedFit") +
  geom_text(data = last_obs, aes(label = name), hjust = -0.1, vjust = 0.5, size = 3, check_overlap = TRUE)


```






###############
################
############### by treatment 

```{R}
long_data1$treat_comb_V1V2 = gsub(
  "HiPD_V1V2\\+CsA_V1V2\\+AZT_V1V2\\+MMF_V1V2\\+IVIg_V1V2\\+RTX_V1V2\\+ISswitch_V1V2",
  "HiPD_V1V2+CsA_V1V2+AZT_V1V2+others",
  long_data1$treat_comb_V1V2)

long_data1$treat_comb_V1V2 = gsub("CsA_V1V2\\+MTX_V1V2\\+ISswitch_V1V2", 
                                 "CsA_V1V2+MTX_V1V2+others",
                                 long_data1$treat_comb_V1V2)



long_data1$treat_comb_V1V2 = gsub("CsA_V1V2\\+Tac_V1V2\\+MTX_V1V2\\+IVIg_V1V2\\+ISswitch_V1V2", 
                                 "CsA_V1V2+MTX_V1V2+others",
                                 long_data1$treat_comb_V1V2)

long_data1$treat_comb_V1V2 = gsub("HiPD_V1V2\\+CsA_V1V2\\+ISswitch_V1V2", 
                                 "HiPD_V1V2+CsA_V1V2+others",
                                 long_data1$treat_comb_V1V2)

long_data1$treat_comb_V1V2 = gsub("HiPD_V1V2\\+CsA_V1V2\\+MTX_V1V2", 
                                 "HiPD_V1V2+CsA_V1V2+others",
                                 long_data1$treat_comb_V1V2)

long_data1$treat_comb_V1V2 = gsub("HiPD_V1V2\\+CsA_V1V2\\+CTX_V1V2\\+AZT_V1V2\\+ISswitch_V1V2", 
                                 "HiPD_V1V2+CsA_V1V2+AZT_V1V2+others",
                                 long_data1$treat_comb_V1V2)

long_data1$treat_comb_V1V2 = gsub("HiPD_V1V2\\+CsA_V1V2\\+AZT_V1V2\\+MTX_V1V2\\+ISswitch_V1V2", 
                                 "HiPD_V1V2+CsA_V1V2+AZT_V1V2+others",
                                 long_data1$treat_comb_V1V2)

long_data1$treat_comb_V1V2 = gsub("HiPD_V1V2\\+CTX_V1V2\\+AZT_V1V2\\+IVIg_V1V2\\+ISswitch_V1V2", 
                                 "HiPD_V1V2+CTX_V1V2++others",
                                 long_data1$treat_comb_V1V2)

```


```{r}
long_data1$treatment = as.factor(long_data1$treat_comb_V1V2)
long_data1 = long_data1[!is.na(long_data1$treatment), ]
```

```{r}


lme_model = lmer(log_qlf ~ log_date + treatment  + (1 | name), data = long_data1)

```

```{R}
library(ggeffects)
library(RColorBrewer)

custom_palette = colorRampPalette(brewer.pal(9, "Set1"))(30)


predicted_data = ggpredict(lme_model, terms = c("log_date [all]", "treatment"))

plot(predicted_data, colors = custom_palette) +
  theme_minimal() +
  labs(#title = "Predicted Tumor Sizes",
       x = "Visit Date",
       y = "QLF Score (log scale)",
       color = "Treatment")

```

```{r}
fixed_effects_pred = predict(lme_model, level = 0)

random_effects_pred = as.numeric(ranef(lme_model, postVar = FALSE)[[1]][, 1])

overall_pred = fixed_effects_pred + rep(random_effects_pred, each = nrow(long_data) / length(random_effects_pred))

long_data$predicted_tumor_size1 = overall_pred
```

```{r}
ggplot(long_data, aes(x = date, y = log_qlf)) +
  geom_line(aes(color = "Observed")) +
  geom_line(aes(y = predicted_tumor_size1, color = "Predicted")) +
  facet_wrap(~ name) +
  labs(color = "Outcome") +
  theme(legend.position = "bottom")

```


```{r}
# First, add the model predictions to the new_data dataframe
#long_data$predicted_tumor_size = predict(lme_model, long_data)
long_data1$predicted_tumor_size = predict(lme_model, re.form = NULL)

```


```{R}
library(ggplot2)

last_obs = long_data %>%
  group_by(name) %>%
  filter(date == max(date))

#custom_palette = c("firebrick2", "springgreen4", "skyblue2", "gold", "pink1", "snow4")

custom_palette = c("firebrick2", "springgreen4")#, "skyblue2", "gold")


ggplot(long_data, aes(x = date, y = QLFCAD, group = name, color = treat_G2)) +
  guides(color = guide_legend(ncol = 1)) +
  scale_color_manual(values = custom_palette) +
  theme(legend.direction = "vertical", legend.box = "vertical") +
  geom_line() +
  geom_point() +
  #scale_color_manual(values = custom_palette) +
  theme_minimal() +
  labs(#title = "Predicted Tumor Sizes (log Scale)",
       x = "Visit Date",
       y = "QLF Score (per visit)",
       color = "Treatment") +
  geom_text(data = last_obs, aes(label = name), hjust = -0.1, vjust = 0.5, size = 3, check_overlap = TRUE)+
  theme_grey(base_size = 20) +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  theme(axis.text = element_text(size = 13),  # Increase size of side labels
        legend.position = "right")


```



```{r}
longitudinal_plot = ggplot() +
  geom_line(data = long_data, aes(x = date, y = log_qlf, group = name, color = treatment), alpha = 0.5) +
  geom_line(data = long_data, aes(x = date, y = predict(lme_model), group = name, color = treatment), linetype = "dashed", size = 1) +
  theme_minimal() +
  labs(title = "Longitudinal Plot of Tumor Size (Observed and Predicted)",
       x = "Visit Date",
       y = "Tumor Size",
       color = "Treatment")

print(longitudinal_plot)

```


- Waterfall plot.

```{r}

#water_df_overall = t_df11[!(t_df11$selectedFit %in% c("not fit")), ]
water_df_overall = qlfffffff

data1 = water_df_overall %>%
  mutate(group = ifelse(change < 0, "dx", "gx")) %>%
  arrange(group, desc(change))

data1$marker = NA # Default marker shape
#data1$marker[data1$name %in% c(66)] = "gdphi group"
data1$marker[data1$name %in% c(28,7,2,69,39,35,76,42,56)] = "QLF Score: No 20% differed"
data1$marker[data1$name %in% c(17, 44, 6, 51, 16, 40, 71, 66, 43, 70)] = "yoyo group (all convex)" 

#yoyo_id = which(data$name == 66)
#no_fit_id = which(data$name == 71)
#no_20_start = which(data$ID == 1)
#no_20_end = which(data$ID == 9)
data1 = data1 %>% 
  mutate(selectedFit = recode(selectedFit, "2 evals not 20% diff" = "stable"))



waterfall_plot = ggplot(data1, aes(x = reorder(name, change), y = change)) +
  geom_col(aes(fill = selectedFit), width = 0.8) +
  labs(
    title = "Waterfall Plot",
    x = "ID",
    y = "Change in Overall QLF Score"
  ) +
  geom_point(aes(shape = marker, color = marker), size = 3, na.rm = TRUE) +
  scale_shape_manual(values = c("QLF Score: No 20% differed" = 8, "yoyo effect (all convex)" = 5)) +
  scale_color_manual(values = c("QLF Score: No 20% differed" = "black", "yoyo effect (all convex)" = "black"))+
  scale_fill_manual(values = c("gx" = "firebrick3", "dx" = "forestgreen", "stable" = "goldenrod1", "gd" = "steelblue1", "gdphi" = "purple1", "not fit" = "grey46"))+                  
  theme_minimal() +
  theme_grey(base_size = 22) +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  theme(axis.text = element_text(size = 8.8),  # Increase size of side labels
        legend.position = "right")# Rotate x-axis labels by 45 degrees

  #geom_text(data = data.frame(x = c(10, 40), y = c(-15, 15), label = c("dx", "gx")), aes(x, y, label = label), inherit.aes = FALSE, vjust = 0, hjust = 0, size = 10, color = "black")



print(waterfall_plot)

```


### waterfall plot by treatment

```{r}
qlf_df = read.csv("treat_combine.csv", sep = ",", header = TRUE)
treat = read.csv("~/Desktop/MS report/data/new treatment comb/IIMQILD_221104_TxGadd.csv",
                 sep = ",", header = TRUE)

colnames(treat)[which(names(treat) == "Patient_ID")] = "SUBJID"
qlf_df = qlf_df[!is.na(qlf_df$Death), ]

treat = treat %>% 
  dplyr:: select(GCIS,
                 GCIS_3G,
                 ISintG4,
                 ISintG3,
                 SUBJID)


```

```{r}
water_df = merge(qlf_df, treat, by = "SUBJID", all.x = TRUE)


```

```{R}
water_df = water_df[!(water_df$selectedFit %in% c("not fit")), ]
#water_df = water_df[!is.na(water_df$Death), ]

water_df$selectedFit = ifelse(water_df$selectedFit == "2 evals not 20% diff", "stable", water_df$selectedFit)

```

```{r}
water_df$combination = paste(water_df$GCIS, water_df$GCIS_3G, water_df$ISintG4, water_df$ISintG3, sep = "+")

```

```{r}
treat$combination = paste(treat$GCIS, treat$GCIS_3G, treat$ISintG4, treat$ISintG3, sep = "+")

```

```{R}
water_df$combination = ifelse(water_df$combination == "0+0+0+0", "treat group 1", water_df$combination)

water_df$combination = ifelse(water_df$combination == "1+2+1+0", "treat group 2", water_df$combination)

water_df$combination = ifelse(water_df$combination == "1+2+2+1", "treat group 3", water_df$combination)

water_df$combination = ifelse(water_df$combination == "1+2+3+2", "treat group 4", water_df$combination)

water_df$combination = ifelse(water_df$combination == "0+1+1+0", "treat group 5", water_df$combination)

water_df$combination = ifelse(water_df$combination == "0+1+2+1", "treat group 6", water_df$combination)

```


```{R}
water_df$treat_comb_V1V2 = gsub(
  "HiPD_V1V2\\+CsA_V1V2\\+AZT_V1V2\\+MMF_V1V2\\+IVIg_V1V2\\+RTX_V1V2\\+ISswitch_V1V2",
  "HiPD_V1V2+CsA_V1V2+AZT_V1V2+others",
  water_df$treat_comb_V1V2)

water_df$treat_comb_V1V2 = gsub("CsA_V1V2\\+MTX_V1V2\\+ISswitch_V1V2", 
                                 "CsA_V1V2+MTX_V1V2+others",
                                 water_df$treat_comb_V1V2)



water_df$treat_comb_V1V2 = gsub("CsA_V1V2\\+Tac_V1V2\\+MTX_V1V2\\+IVIg_V1V2\\+ISswitch_V1V2", 
                                 "CsA_V1V2+MTX_V1V2+others",
                                 water_df$treat_comb_V1V2)

water_df$treat_comb_V1V2 = gsub("HiPD_V1V2\\+CsA_V1V2\\+ISswitch_V1V2", 
                                 "HiPD_V1V2+CsA_V1V2+others",
                                 water_df$treat_comb_V1V2)

water_df$treat_comb_V1V2 = gsub("HiPD_V1V2\\+CsA_V1V2\\+MTX_V1V2", 
                                 "HiPD_V1V2+CsA_V1V2+others",
                                 water_df$treat_comb_V1V2)

water_df$treat_comb_V1V2 = gsub("HiPD_V1V2\\+CsA_V1V2\\+CTX_V1V2\\+AZT_V1V2\\+ISswitch_V1V2", 
                                 "HiPD_V1V2+CsA_V1V2+AZT_V1V2+others",
                                 water_df$treat_comb_V1V2)

water_df$treat_comb_V1V2 = gsub("HiPD_V1V2\\+CsA_V1V2\\+AZT_V1V2\\+MTX_V1V2\\+ISswitch_V1V2", 
                                 "HiPD_V1V2+CsA_V1V2+AZT_V1V2+others",
                                 water_df$treat_comb_V1V2)

water_df$treat_comb_V1V2 = gsub("HiPD_V1V2\\+CTX_V1V2\\+AZT_V1V2\\+IVIg_V1V2\\+ISswitch_V1V2", 
                                 "HiPD_V1V2+CTX_V1V2++others",
                                 water_df$treat_comb_V1V2)
```



```{r}
water_df$log_d = log(water_df$d)
```


```{r}
water_df = qlfffffff

water_df$marker = NA # Default marker shape
#data1$marker[data1$name %in% c(66)] = "gdphi group" 
#water_df$marker[water_df$name %in% c(28,7,2,69,39,35,76,42,56)] = "QLF Score: No 20% differed" 
water_df$marker[water_df$name %in% c(17, 44, 6, 51, 16, 40, 71, 66, 43, 70)] = "convex group: patients with both growth and decay rate"  #specific IDs for star marker
water_df$marker[water_df$name %in% c(2, 7, 28, 35, 39, 42, 56, 69, 76)] = "stable: whose overall QLF score change less than 20%"  #specific IDs for star marker

water_df$marker = ifelse(water_df$group == "concave", water_df$group, water_df$marker)

custom_palette = c("firebrick2", "springgreen4")#, "skyblue2", "gold")#, "gold", "pink1", "snow4")


waterfall_plot = ggplot(water_df, aes(x = reorder(name, change), y = change)) +
  geom_col(aes(fill = treat_G2.y), width = 0.9) +
  scale_fill_manual(values = custom_palette) +
  guides(fill = guide_legend(ncol = 1)) +
  theme(legend.direction = "vertical", legend.box = "vertical") +
  geom_label(
    aes(x = 12, y = -15, label = paste("dx")),
    label.padding = unit(1, "lines"),
    label.size = 1,
    color = "snow4"
  ) +
  geom_label(
    aes(x = 67, y = 12, label = paste("gx")),
    label.padding = unit(1, "lines"),
    label.size = 1,
    color = "snow4"
  ) +
  #scale_fill_manual(values = c("T1" = "red", "T2" = "blue", "T3" = "green")) +
  geom_point(aes(shape = marker, color = marker), size = 2.6, na.rm = TRUE) +
  scale_shape_manual(values = c("stable: whose overall QLF score change less than 20%" = 5, "convex group: patients with both growth and decay rate" = 8, "concave" = 10)) +
  scale_color_manual(values = c("stable: whose overall QLF score change less than 20%" = "black", "convex group: patients with both growth and decay rate" = "black", "concave" = "black")) +
  labs(
    title = "Waterfall Plot",
    x = "ID",
    y = "Change in Overall QLF Score",
    fill = "Treatment Combination"
  ) +
  theme_minimal() +
  theme_grey(base_size = 15) +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  theme(axis.text = element_text(size = 7.5),  # Increase size of side labels
        legend.position = "right")# Rotate x-axis labels by 45 degrees
  #geom_text(data = data.frame(x = c(10, 40), y = c(-15, 15), label = c("dx", "gx")), aes(x, y, label = label), inherit.aes = FALSE, vjust = 0, hjust = 0, size = 10, color = "black")



print(waterfall_plot)

```

```{r}
### summary stats by treatments

library(dplyr)

# Calculate summary statistics by treatment group
summary_stats = qlfffffff %>%
  group_by(treat_G2.y) %>%
  summarise(
    patient = n(),  # Count the number of rows (patients) in each group
    QLF_baseline_mean = mean(initial_size),
    QLF_overall_change_mean = mean(change),
    duration_mean = mean(total_fu_date),
  )

# View the summary statistics
print(summary_stats)





```



```{r}
t_df$treat_comb_V1V2 = gsub(
  "HiPD_V1V2\\+CsA_V1V2\\+AZT_V1V2\\+MMF_V1V2\\+IVIg_V1V2\\+RTX_V1V2\\+ISswitch_V1V2",
  "HiPD_V1V2+CsA_V1V2+AZT_V1V2+others",
  t_df$treat_comb_V1V2)

t_df$treat_comb_V1V2 = gsub("CsA_V1V2\\+MTX_V1V2\\+ISswitch_V1V2", 
                                 "CsA_V1V2+MTX_V1V2+others",
                                 t_df$treat_comb_V1V2)



t_df$treat_comb_V1V2 = gsub("CsA_V1V2\\+Tac_V1V2\\+MTX_V1V2\\+IVIg_V1V2\\+ISswitch_V1V2", 
                                 "CsA_V1V2+MTX_V1V2+others",
                                 t_df$treat_comb_V1V2)

t_df$treat_comb_V1V2 = gsub("HiPD_V1V2\\+CsA_V1V2\\+ISswitch_V1V2", 
                                 "HiPD_V1V2+CsA_V1V2+others",
                                 t_df$treat_comb_V1V2)

t_df$treat_comb_V1V2 = gsub("HiPD_V1V2\\+CsA_V1V2\\+MTX_V1V2", 
                                 "HiPD_V1V2+CsA_V1V2+others",
                                 t_df$treat_comb_V1V2)

t_df$treat_comb_V1V2 = gsub("HiPD_V1V2\\+CsA_V1V2\\+CTX_V1V2\\+AZT_V1V2\\+ISswitch_V1V2", 
                                 "HiPD_V1V2+CsA_V1V2+AZT_V1V2+others",
                                 t_df$treat_comb_V1V2)

t_df$treat_comb_V1V2 = gsub("HiPD_V1V2\\+CsA_V1V2\\+AZT_V1V2\\+MTX_V1V2\\+ISswitch_V1V2", 
                                 "HiPD_V1V2+CsA_V1V2+AZT_V1V2+others",
                                 t_df$treat_comb_V1V2)

t_df$treat_comb_V1V2 = gsub("HiPD_V1V2\\+CTX_V1V2\\+AZT_V1V2\\+IVIg_V1V2\\+ISswitch_V1V2", 
                                 "HiPD_V1V2+CTX_V1V2++others",
                                 t_df$treat_comb_V1V2)
```




```{r}
treat = read.csv("~/Desktop/MS report/data/Data-selected 2/IIMQILD_221104_Box.csv", sep = ",", header = TRUE)

colnames(treat)[which(names(treat) == "Patient_ID")] = "SUBJID"

treat$name = as.numeric(factor(treat$SUBJID, 
                  levels=unique(treat$SUBJID)))
```

```{r}


library(dplyr)

treat1 = merge(treat, tt_df, by = "SUBJID", all = TRUE)

```


```{r}
#model = coxph(Surv(time_mon, Death.y) ~ HiPD_V1V2 + CsA_V1V2 + CTX_V1V2 + AZT_V1V2 +
 #               Tac_V1V2 + MMF_V1V2 + MTX_V1V2 + IVIg_V1V2 + RTX_V1V2 + 
  #              ISswitch_V1V2 + Age.y + Sex.y, data = treat1)

model = coxph(Surv(time_mon, Death) ~ treat_comb_V1V2 + Age + Sex + growth_tertile1 +
                growth_tertile2 + growth_tertile3 + decay_tertile1 + 
                decay_tertile2 + decay_tertile3 + remainder, data = t_df)

# Extract hazard ratios
tibble::tibble(exp(model$coef))
summary(model)


```


```{r}                      

X = t_df[, c("treat_comb_V1V2", "Age", "Sex", 
               "growth_tertile1", "growth_tertile2", "growth_tertile3",
              "decay_tertile1", "decay_tertile2", "decay_tertile3", "remainder")]
              

X = as.matrix(X)  # Convert the data frame to a matrix

Y = Surv(t_df$time_mon, t_df$Death)

set.seed(123)  # For reproducibility
cv_fit = cv.glmnet(x = X, y = Y, family = "cox", alpha = 1)

plot(cv_fit)

optimal_lambda = cv_fit$lambda.min
coef(cv_fit, s = optimal_lambda)



```
                      
                      

```{r}                      

X = treat1[, c("HiPD_V1V2", "CsA_V1V2", "CTX_V1V2","AZT_V1V2", 
                      "Tac_V1V2", "MMF_V1V2", "MTX_V1V2", "IVIg_V1V2",
                      "RTX_V1V2", "ISswitch_V1V2", "Age.y", "Sex.y", 
               "growth_tertile1", "growth_tertile2", "growth_tertile3",
              "decay_tertile1", "decay_tertile2", "decay_tertile3", "remainder")]
              

X = as.matrix(X)  # Convert the data frame to a matrix

Y = Surv(treat1$time_mon, treat1$Death.y)

set.seed(123)  # For reproducibility
cv_fit = cv.glmnet(x = X, y = Y, family = "cox", alpha = 1)

plot(cv_fit)

optimal_lambda = cv_fit$lambda.min
coef(cv_fit, s = optimal_lambda)



```

```{r}
a = c(1.21891234, 1.26898374, 0.85263132, -1.76744343, -0.59427534, 0, 0.19747051, 0, 0,
      -2.98655196, 0.06667797, -0.40184424, -2.42092043, -2.56447048,
      2.46664244, 0, -0.58974028, -1.04298533, 0.79686760)

exp(a)

```



```{r}
water_df$marker = NA # Default marker shape
#data1$marker[data1$name %in% c(66)] = "gdphi group"
#water_df$marker[water_df$name %in% c(28,7,2,69,39,35,76,42,56)] = "QLF Score: No 20% differed" 
water_df$marker[water_df$name %in% c(17, 44, 6, 51, 16, 40, 71, 66, 43, 70)] = "Yoyo group (convex): patients with both growth and decay rate"  #specific IDs for star marker
water_df$marker[water_df$name %in% c(2, 7, 28, 35, 39, 42, 56, 69, 76)] = "Stable: whose overall QLF score change less than 20%"  #specific IDs for star marker
water_df$marker[water_df$name %in% c(17, 66, 6, 80)] = "Top 4 treatment comb leads to highest decay rate in QLF score over time"

custom_palette = c("firebrick2", "springgreen4", "skyblue2")#, "gold")#, "pink1", "snow4")


waterfall_plot = ggplot(water_df, aes(x = reorder(name, change), y = change)) +
  geom_col(aes(fill = ISintG3), width = 0.8) +
  scale_fill_manual(values = custom_palette) +
  guides(fill = guide_legend(ncol = 1)) +
  theme(legend.direction = "vertical", legend.box = "vertical") +
  geom_label(
    aes(x = 12, y = -15, label = paste("dx")),
    label.padding = unit(1, "lines"),
    label.size = 1,
    color = "snow4"
  ) +
  geom_label(
    aes(x = 67, y = 12, label = paste("gx")),
    label.padding = unit(1, "lines"),
    label.size = 1,
    color = "snow4"
  ) +
  #scale_fill_manual(values = c("T1" = "red", "T2" = "blue", "T3" = "green")) +
  geom_point(aes(shape = marker, color = marker), size = 2.6, na.rm = TRUE) +
  scale_shape_manual(values = c("Yoyo group (convex): patients with both growth and decay rate" = 8, "Stable: whose overall QLF score change less than 20%" = 5, "Top 4 treatment comb leads to highest decay rate in QLF score over time" = 18)) +
  scale_color_manual(values = c("Yoyo group (convex): patients with both growth and decay rate" = "black", "Stable: whose overall QLF score change less than 20%" = "black", "Top 4 treatment comb leads to highest decay rate in QLF score over time" = "black")) +
  labs(
    title = "Waterfall Plot",
    x = "ID",
    y = "Change in Overall QLF Score",
    fill = "Treatment Combination"
  ) +
  theme_minimal() +
  theme_grey(base_size = 14.4) +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  theme(axis.text = element_text(size = 7.5),  # Increase size of side labels
        legend.position = "right")# Rotate x-axis labels by 45 degrees
  #geom_text(data = data.frame(x = c(10, 40), y = c(-15, 15), label = c("dx", "gx")), aes(x, y, label = label), inherit.aes = FALSE, vjust = 0, hjust = 0, size = 10, color = "black")



print(waterfall_plot)
```

#####################################################
#####################################################
#####################################################
#####################################################

```{r}
subset_1 = subset(qlfffffff, treat_G2.y == "G1")
subset_1_g = subset_1[!is.na(subset_1$g) & !is.na(subset_1$Death.x),]
subset_1_d = subset_1[!is.na(subset_1$d) & !is.na(subset_1$Death.x),]

subset_2 = subset(qlfffffff, treat_G2.y == "G2")
subset_2_g = subset_2[!is.na(subset_2$g) & !is.na(subset_2$Death.x),]
subset_2_d = subset_2[!is.na(subset_2$d) & !is.na(subset_2$Death.x),]

#subset_3 = subset(qlfffffff, ISintG3 == "ISint3_G3")
#subset_3_g = subset_3[!is.na(subset_3$g) & !is.na(subset_3$Death.x),]
#subset_3_d = subset_3[!is.na(subset_3$d) & !is.na(subset_3$Death.x),]

#subset_4 = subset(qlfffffff, ISintG4.y == "ISint4_G3")
#subset_4_g = subset_4[!is.na(subset_4$g) & !is.na(subset_4$Death.x),]
#subset_4_d = subset_4[!is.na(subset_4$d) & !is.na(subset_4$Death.x),]
```



```{r}
## decay
median_decay_group1 = median(subset_1_d$d)
median_decay_group2 = median(subset_2_d$d)

wilcox_decay = wilcox.test(subset_1_d$d, subset_2_d$d, alternative = "two.sided")

half_life_group1 = log(2) / median_decay_group1
half_life_group2 = log(2) / median_decay_group2


print(paste("Group1 decay median:", median_decay_group1))
print(paste("Group2 decay median:", median_decay_group2))

print(paste("Group1 half-life:", half_life_group1))
print(paste("Group2 half-life:", half_life_group2))

print(paste("P-value for decay comparison:", wilcox_decay$p.value))
```
```{r}
## decay
median_growth_group1 = median(subset_1_g$g)
median_growth_group2 = median(subset_2_g$g)

wilcox_growth = wilcox.test(subset_1_g$g, subset_2_g$g)

double_life_group1 = log(2) / median_growth_group1
double_life_group2 = log(2) / median_growth_group2


print(paste("Group1 growth median:", median_growth_group1))
print(paste("Group2 growth median:", median_growth_group2))

print(paste("Group1 doubling-life:", double_life_group1))
print(paste("Group2 doubling-life:", double_life_group2))

print(paste("P-value for growth comparison:", wilcox_growth$p.value))
```

```{R}
iqr = subset_2_g$g

# Calculate half-life and doubling time for each individual
half_life_group1 = log(2) / iqr

# Calculate IQR
quantile(half_life_group1, 0.25)
quantile(half_life_group1, 0.75)
IQR(half_life_group1)

```


```{r}
# Function to calculate difference in means
perm_func = function(x, y) {
  all_values = c(x, y)
  shuffled_values = sample(all_values)
  shuffled_x = shuffled_values[1:length(x)]
  shuffled_y = shuffled_values[(length(x) + 1):length(all_values)]
  
  return(mean(shuffled_x) - mean(shuffled_y))
}

# Perform the permutation test for growth rates
set.seed(42) 
num_permutations = 10000
perm_diffs_g = replicate(num_permutations, perm_func(subset_1_g$g, subset_2_g$g))

# Calculate the actual difference in means for growth rates
actual_diff_g = mean(subset_1_g$g) - mean(subset_2_g$g)

# Calculate the p-value for growth rates
p_value_g = sum(abs(perm_diffs_g) >= abs(actual_diff_g)) / num_permutations

# Perform the permutation test for decay rates
perm_diffs_d = replicate(num_permutations, perm_func(subset_1_d$d, subset_2_d$d))

# Calculate the actual difference in means for decay rates
actual_diff_d = mean(subset_1_d$d) - mean(subset_2_d$d)

# Calculate the p-value for decay rates
p_value_d = sum(abs(perm_diffs_d) >= abs(actual_diff_d)) / num_permutations



```


```{R}
library(gridExtra)

# Combine the datasets
df_d = data.frame(
  Value = c(subset_1_d$d, subset_2_d$d),
  Group = c(rep("Treatment Group1", length(subset_1_d$d)), rep("Treatment Group2", length(subset_2_d$d)))
)

# Perform a Wilcoxon test
wilcox_decay = wilcox.test(subset_1_d$d, subset_2_d$d, alternative = "two.sided")

# Create the decay plot
plot_d = ggplot(df_d, aes(x = Group, y = Value)) +
  geom_boxplot(outlier.shape = NA) +  # Suppressing outliers in the boxplot
  geom_jitter(width = 0.2) +
  labs(x = "Group", y = "decay rate (d)") +
  annotate("text", x = 1.5, y = max(df_d$Value), label = paste("p-value =", round(wilcox_decay$p.value, 3)))

# Combine the datasets
df_g = data.frame(
  Value = c(subset_1_g$g, subset_2_g$g),
  Group = c(rep("Treatment Group1", length(subset_1_g$g)), rep("Treatment Group2", length(subset_2_g$g)))
)

# Perform a Wilcoxon test
wilcox_growth = wilcox.test(subset_1_g$g, subset_2_g$g, alternative = "two.sided")

# Create the growth plot
plot_g = ggplot(df_g, aes(x = Group, y = Value)) +
  geom_boxplot(outlier.shape = NA) +  # Suppressing outliers in the boxplot
  geom_jitter(width = 0.2) +
  labs(x = "Group", y = "growth rate (g)") +
  annotate("text", x = 1.5, y = max(df_g$Value), label = paste("p-value =", round(wilcox_growth$p.value, 3)))

# Combine the plots
grid.arrange(plot_d, plot_g, ncol = 2)


```

```{r}

#water_df_overall = t_df11[!(t_df11$selectedFit %in% c("not fit")), ]
water_df_overall = qlfffffff

data1 = water_df_overall %>%
  mutate(group = ifelse(change < 0, "dx", "gx")) %>%
  arrange(group, desc(change))

#data1$marker = NA # Default marker shape
#data1$marker[data1$name %in% c(66)] = "gdphi group"
#data1$marker[data1$name %in% c(28,7,2,69,39,35,76,42,56)] = "QLF Score: No 20% differed" 
#data1$marker[data1$name %in% c(17, 44, 6, 51, 16, 40, 71, 66, 43, 70)] = "yoyo group (all convex)" 

#yoyo_id = which(data$name == 66)
#no_fit_id = which(data$name == 71)
#no_20_start = which(data$ID == 1)
#no_20_end = which(data$ID == 9)
data1 = data1 %>% 
  mutate(selectedFit = recode(selectedFit, "2 evals not 20% diff" = "stable")) %>%
  mutate(selectedFit = recode(selectedFit, "gx" = "growth (gx)")) %>%
  mutate(selectedFit = recode(selectedFit, "dx" = "decay (dx)")) %>%
  mutate(selectedFit = recode(selectedFit, "gd" = "convex")) %>%
  mutate(selectedFit = recode(selectedFit, "gdphi" = "convex")) %>%
  mutate(selectedFit = recode(selectedFit, "not fit" = "concave"))

data1$Patterns = data1$selectedFit



waterfall_plot = ggplot(data1, aes(x = reorder(name, change), y = change)) +
  geom_col(aes(fill = Patterns), width = 0.8) +
  labs(
    title = "Waterfall Plot",
    x = "ID",
    y = "Change in Overall QLF Score"
  ) +
  #geom_point(aes(shape = marker, color = marker), size = 3, na.rm = TRUE) +
  #scale_shape_manual(values = c("QLF Score: No 20% differed" = 8)) +
  #scale_color_manual(values = c("QLF Score: No 20% differed" = "black"))+
  scale_fill_manual(values = c("growth (gx)" = "firebrick3", "decay (dx)" = "forestgreen", "stable" = "goldenrod1", "convex" = "purple1", "concave" = "grey46"))+                  
  theme_minimal() +
  theme_grey(base_size = 22) +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  theme(axis.text = element_text(size = 9),  # Increase size of side labels
        legend.position = "right")
  #geom_text(data = data.frame(x = c(10, 40), y = c(-15, 15), label = c("dx", "gx")), aes(x, y, label = label), inherit.aes = FALSE, vjust = 0, hjust = 0, size = 10, color = "black")



print(waterfall_plot)
```

